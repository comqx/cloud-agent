version: '3.8'

services:
  cloud:
    image: docker.io/comqx/cloud-agent-cloud:latest
    network_mode: host
    pull_policy: always
    volumes:
      - /data/cloud:/app/data
      - /data/cloud-files:/app/data/files
      # 证书目录（用于 HTTPS/WSS）
      - /data/certs:/app/certs:ro
    environment:
      # 与 Dockerfile.cloud 中的启动参数保持一致
      - CLOUD_ADDR=:8443
      - CLOUD_DB=/app/data/cloud.db
      - CLOUD_STORAGE=/app/data/files
      - CLOUD_CERT=/app/certs/server.crt
      - CLOUD_KEY=/app/certs/server.key
    restart: unless-stopped

  agent:
    image: docker.io/comqx/cloud-agent-agent:latest
    network_mode: host
    pull_policy: always
    environment:
      # 连接 Cloud 的 WSS（如用自签证书，建议开启跳过校验；如用受信任证书，建议设为 false）
      - CLOUD_URL=wss://localhost:8443
      - WS_SKIP_VERIFY=true
      - AGENT_ID=${AGENT_ID:-}
      - AGENT_NAME=local
      - K8S_CLUSTER_NAME=local
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # 如果需要执行 Docker 命令
      - /data/agent:/app/data

  ui:
    image: docker.io/comqx/cloud-agent-ui:latest
    network_mode: host
    pull_policy: always
    environment:
      # UI 容器内 Nginx 反代到 Cloud（Cloud 若启用 TLS，这里用 https://）
      - CLOUD_API_URL=https://localhost:8443
      - CLOUD_WS_URL=https://localhost:8443
    restart: unless-stopped