version: '3.8'

services:
  cloud:
    build:
      context: ..
      dockerfile: Dockerfile.cloud
    ports:
      - "8080:8080"
    volumes:
      - cloud-data:/app/data
      - cloud-files:/app/data/files
    environment:
      - DB_PATH=/app/data/cloud.db
      - FILE_STORAGE=/app/data/files
    restart: unless-stopped
    networks:
      - tiangong-deploy

  agent:
    build:
      context: ..
      dockerfile: Dockerfile.agent
    depends_on:
      - cloud
    environment:
      - CLOUD_URL=http://cloud:8080
      - AGENT_ID=${AGENT_ID:-}
      - AGENT_NAME=${AGENT_NAME:-agent-1}
      - K8S_CLUSTER_NAME=${K8S_CLUSTER_NAME:-}
    restart: unless-stopped
    networks:
      - tiangong-deploy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # 如果需要执行 Docker 命令
      - agent-data:/app/data

  ui:
    build:
      context: ..
      dockerfile: Dockerfile.ui
    ports:
      - "80:80"
    depends_on:
      - cloud
    environment:
      - CLOUD_API_URL=http://cloud:8080
      - CLOUD_WS_URL=http://cloud:8080
    restart: unless-stopped
    networks:
      - tiangong-deploy

volumes:
  cloud-data:
  cloud-files:
  agent-data:


networks:
  tiangong-deploy:
    driver: bridge
