# 阶段2: 运行阶段
FROM hub.glodon.com/glodon-pub/debian:stable-slim-base

# 定义构建参数（由 buildx 自动注入）
ARG TARGETOS
ARG TARGETARCH

# RUN apt-get update && \
#     apt-get install -y --no-install-recommends \
#     ca-certificates \
#     && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 从本地复制对应架构的二进制文件
COPY bin/${TARGETOS}/${TARGETARCH}/cloud .

# 复制配置文件
COPY configs/agent-plugins.yaml /app/configs/agent-plugins.yaml

# 创建数据目录
RUN mkdir -p /app/data/files

EXPOSE 8080

ENV CLOUD_ADDR=:8080
ENV CLOUD_DB=/app/data/cloud.db
ENV CLOUD_STORAGE=/app/data/files
ENV CLOUD_CERT=
ENV CLOUD_KEY=

CMD ["sh", "-c", "exec ./cloud -addr \"${CLOUD_ADDR}\" -db \"${CLOUD_DB}\" -storage \"${CLOUD_STORAGE}\" -cert \"${CLOUD_CERT}\" -key \"${CLOUD_KEY}\""]

