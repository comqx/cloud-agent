# Tiangong Deploy - 部署指南

## 部署方式概览

Tiangong Deploy 支持多种部署方式：
1. **Docker Compose** - 适合开发和测试
2. **Kubernetes/Helm** - 适合生产环境
3. **二进制部署** - 适合特殊场景

---

## 1. Docker Compose 部署

### 前置要求
- Docker 20.10+
- Docker Compose 2.0+

### 快速开始

```bash
# 1. 克隆仓库
git clone https://github.com/your-org/tiangong-deploy.git
cd tiangong-deploy

# 2. 生成自签名证书（可选，用于 HTTPS/WSS）
./scripts/generate-cert.sh

# 3. 启动服务
cd deployments
docker-compose up -d

# 4. 查看日志
docker-compose logs -f

# 5. 访问 UI
open http://localhost
```

### 服务说明

| 服务 | 端口 | 说明 |
|------|------|------|
| **cloud** | 8080/8443 | Cloud API 服务 |
| **ui** | 80 | Web UI |
| **agent** | - | Agent 服务 |

### 配置文件

`docker-compose.yml`:
```yaml
services:
  cloud:
    image: tiangong-deploy/cloud:latest
    ports:
      - "8080:8080"
      - "8443:8443"
    volumes:
      - ./data:/app/data
      - ./certs:/app/certs
    environment:
      - CLOUD_ADDR=:8443
      - CLOUD_CERT=/app/certs/server.crt
      - CLOUD_KEY=/app/certs/server.key

  ui:
    image: tiangong-deploy/ui:latest
    ports:
      - "80:80"
    environment:
      - CLOUD_API_URL=http://cloud:8080
      - CLOUD_WS_URL=http://cloud:8080

  agent:
    image: tiangong-deploy/agent:latest
    environment:
      - CLOUD_URL=wss://cloud:8443
      - AGENT_ID=agent-1
      - AGENT_NAME=agent-1
      - WS_SKIP_VERIFY=true
```

---

## 2. Kubernetes/Helm 部署

### 前置要求
- Kubernetes 1.20+
- Helm 3.0+

### 使用 Helm 安装

```bash
# 1. 添加 Helm 仓库（如果已发布）
helm repo add tiangong https://your-helm-repo.com
helm repo update

# 2. 安装
helm install tiangong-deploy tiangong/tiangong-deploy \
  --namespace tiangong \
  --create-namespace \
  --set cloud.service.type=LoadBalancer \
  --set ui.enabled=true \
  --set ui.service.type=LoadBalancer

# 3. 查看状态
kubectl get pods -n tiangong
kubectl get svc -n tiangong

# 4. 获取访问地址
kubectl get svc tiangong-deploy-ui -n tiangong
```

### 使用 YAML 文件部署

```bash
# 1. 创建命名空间
kubectl create namespace tiangong

# 2. 部署 Cloud
kubectl apply -f deployments/helm/tiangong-deploy/templates/deployment-cloud.yaml
kubectl apply -f deployments/helm/tiangong-deploy/templates/service-cloud.yaml

# 3. 部署 UI
kubectl apply -f deployments/helm/tiangong-deploy/templates/deployment-ui.yaml
kubectl apply -f deployments/helm/tiangong-deploy/templates/service-ui.yaml

# 4. 部署 Agent (DaemonSet)
kubectl apply -f deployments/agent-daemonset.yaml
```

### Helm Values 配置

`values.yaml`:
```yaml
cloud:
  image:
    repository: tiangong-deploy/cloud
    tag: latest
  service:
    type: ClusterIP
    port: 8080
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "2000m"

ui:
  enabled: true
  image:
    repository: tiangong-deploy/ui
    tag: latest
  service:
    type: LoadBalancer
    port: 80
  cloudURL: "http://tiangong-deploy-cloud:8080"

agent:
  enabled: true
  image:
    repository: tiangong-deploy/agent
    tag: latest
  cloudURL: "wss://tiangong-deploy-cloud:8443"
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
```

---

## 3. TLS/WSS 配置

### 生成自签名证书

```bash
# 使用提供的脚本
./scripts/generate-cert.sh

# 手动生成
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout certs/server.key \
  -out certs/server.crt \
  -subj "/CN=localhost"
```

### 配置 Cloud 使用 TLS

**Docker Compose**:
```yaml
cloud:
  environment:
    - CLOUD_ADDR=:8443
    - CLOUD_CERT=/app/certs/server.crt
    - CLOUD_KEY=/app/certs/server.key
  volumes:
    - ./certs:/app/certs
```

**Kubernetes Secret**:
```bash
# 创建 Secret
kubectl create secret tls tiangong-tls \
  --cert=certs/server.crt \
  --key=certs/server.key \
  -n tiangong

# 在 Deployment 中使用
volumes:
- name: tls
  secret:
    secretName: tiangong-tls
volumeMounts:
- name: tls
  mountPath: /app/certs
```

### 配置 Agent 使用 WSS

```yaml
agent:
  environment:
    - CLOUD_URL=wss://your-cloud-server:8443
    - WS_SKIP_VERIFY=true  # 自签名证书时设置为 true
```

---

## 4. 环境变量配置

### Cloud 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `CLOUD_ADDR` | `:8080` | 监听地址 |
| `CLOUD_DB` | `/app/data/cloud.db` | 数据库路径 |
| `CLOUD_STORAGE` | `/app/data/files` | 文件存储路径 |
| `CLOUD_CERT` | - | TLS 证书路径 |
| `CLOUD_KEY` | - | TLS 私钥路径 |

### Agent 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `CLOUD_URL` | `http://cloud:8080` | Cloud 服务地址 |
| `AGENT_ID` | - | Agent ID |
| `AGENT_NAME` | `agent` | Agent 名称 |
| `WS_SKIP_VERIFY` | `false` | 跳过 TLS 证书验证 |
| `K8S_CLUSTER_NAME` | - | Kubernetes 集群名称 |
| `AGENT_PLUGINS_CONFIG` | `configs/agent-plugins.yaml` | 插件配置文件路径 |
| `AGENT_SECURITY_CONFIG` | `configs/agent-security.yaml` | 安全配置文件路径 |

### UI 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `CLOUD_API_URL` | `http://cloud:8080` | Cloud API 地址 |
| `CLOUD_WS_URL` | `http://cloud:8080` | Cloud WebSocket 地址 |

---

## 5. 安全配置

### 命令白名单配置

编辑 `configs/agent-security.yaml`:

```yaml
# 启用命令白名单
command_whitelist_enabled: true

# 允许的命令
allowed_commands:
  - pattern: "^kubectl\\s+get\\s+.*"
    description: "Kubernetes 查询"
  
  - pattern: "^docker\\s+ps\\s*.*"
    description: "Docker 查看"

# 禁止的命令
blocked_patterns:
  - pattern: ".*rm\\s+-rf\\s+/.*"
    reason: "禁止删除根目录"
  
  - pattern: ".*(shutdown|reboot).*"
    reason: "禁止关机重启"
```

### RBAC 权限配置

Agent DaemonSet 使用 `cloud-agent` ServiceAccount，权限定义在 `deployments/agent-daemonset.yaml`:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloud-agent
rules:
  # 只读权限
  - apiGroups: [""]
    resources: ["pods", "services", "nodes"]
    verbs: ["get", "list", "watch"]
  
  # 有限的写权限
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "delete"]
```

---

## 6. 数据持久化

### Docker Compose

```yaml
volumes:
  cloud-data:
    driver: local
  
services:
  cloud:
    volumes:
      - cloud-data:/app/data
```

### Kubernetes PVC

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cloud-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

---

## 7. 监控和日志

### 查看日志

**Docker Compose**:
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f cloud
docker-compose logs -f agent
```

**Kubernetes**:
```bash
# 查看 Cloud 日志
kubectl logs -f deployment/tiangong-deploy-cloud -n tiangong

# 查看 Agent 日志
kubectl logs -f daemonset/cloud-agent -n tiangong

# 查看审计日志
kubectl logs -f daemonset/cloud-agent -n tiangong | grep AUDIT
```

### 健康检查

```bash
# Cloud 健康检查
curl http://localhost:8080/health

# 查看 Agent 状态
kubectl get pods -l app=cloud-agent -n tiangong
```

---

## 8. 升级和回滚

### Docker Compose 升级

```bash
# 1. 拉取新镜像
docker-compose pull

# 2. 重启服务
docker-compose up -d

# 3. 查看状态
docker-compose ps
```

### Kubernetes 升级

```bash
# 使用 Helm 升级
helm upgrade tiangong-deploy tiangong/tiangong-deploy \
  --namespace tiangong \
  --set cloud.image.tag=v1.1.0

# 查看升级状态
kubectl rollout status deployment/tiangong-deploy-cloud -n tiangong

# 回滚
helm rollback tiangong-deploy -n tiangong
```

---

## 9. 故障排查

### 常见问题

**1. Agent 无法连接到 Cloud**
```bash
# 检查网络连通性
kubectl exec -it <agent-pod> -- curl -k https://tiangong-deploy-cloud:8443

# 检查证书
kubectl exec -it <agent-pod> -- openssl s_client -connect tiangong-deploy-cloud:8443
```

**2. 命令执行失败**
```bash
# 查看审计日志
kubectl logs <agent-pod> | grep AUDIT

# 检查安全配置
kubectl exec -it <agent-pod> -- cat /app/configs/agent-security.yaml
```

**3. UI 无法访问**
```bash
# 检查 Service
kubectl get svc tiangong-deploy-ui -n tiangong

# 检查 Pod 状态
kubectl get pods -l app=ui -n tiangong
```

---

## 10. 生产环境建议

### 高可用部署
- Cloud 多副本部署（需要共享存储）
- 使用 PostgreSQL 替代 SQLite
- 配置负载均衡器

### 安全加固
- 启用 TLS/WSS
- 配置命令白名单
- 限制 RBAC 权限
- 定期审计日志

### 性能优化
- 调整资源限制
- 配置并发控制
- 使用 SSD 存储

### 备份策略
- 定期备份数据库
- 备份配置文件
- 备份证书和密钥
