# Cloud UI - 开发指南

## 项目结构

```
tiangong-deploy/
├── cmd/                    # 主程序入口
│   ├── cloud/             # Cloud 服务
│   └── agent/             # Agent 服务
├── internal/              # 内部包
│   ├── common/            # 公共类型和协议
│   ├── cloud/             # Cloud 服务逻辑
│   │   ├── api/           # API 处理器
│   │   ├── storage/       # 数据存储
│   │   └── websocket/     # WebSocket 服务
│   └── agent/             # Agent 服务逻辑
│       ├── client/        # WebSocket 客户端
│       ├── executor/      # 执行器管理
│       ├── plugins/       # 执行器插件
│       └── security/      # 安全组件
├── cloud-ui/              # 前端 UI
│   ├── src/
│   │   ├── components/    # React 组件
│   │   ├── services/      # API 和 WebSocket 服务
│   │   └── pages/         # 页面
│   └── vite.config.ts
├── configs/               # 配置文件
│   ├── agent-plugins.yaml # Agent 插件配置
│   └── agent-security.yaml# 安全配置
├── deployments/           # 部署配置
│   ├── docker-compose.yml
│   └── helm/              # Helm Charts
├── scripts/               # 脚本
└── docs/                  # 文档
```

---

## 开发环境设置

### 前置要求
- Go 1.21+
- Node.js 18+
- Docker 20.10+
- Kubernetes 1.20+ (可选)

### 克隆仓库

```bash
git clone https://github.com/your-org/tiangong-deploy.git
cd tiangong-deploy
```

### 安装依赖

**后端**:
```bash
go mod download
```

**前端**:
```bash
cd cloud-ui
npm install
```

---

## 本地开发

### 启动 Cloud 服务

```bash
# 开发模式（不使用 TLS）
go run cmd/cloud/main.go \
  -addr :8080 \
  -db ./data/cloud.db \
  -storage ./data/files

# 使用 TLS
./scripts/generate-cert.sh
go run cmd/cloud/main.go \
  -addr :8443 \
  -cert ./certs/server.crt \
  -key ./certs/server.key \
  -db ./data/cloud.db \
  -storage ./data/files
```

### 启动 Agent 服务

```bash
go run cmd/agent/main.go \
  -cloud http://localhost:8080 \
  -id agent-dev \
  -name agent-dev
```

### 启动 UI 开发服务器

```bash
cd cloud-ui
npm run dev
```

访问 http://localhost:5173

---

## 构建

### 构建二进制文件

```bash
# 构建 Cloud
CGO_ENABLED=0 go build -o bin/cloud ./cmd/cloud

# 构建 Agent
CGO_ENABLED=0 go build -o bin/agent ./cmd/agent
```

### 构建 Docker 镜像

```bash
# 构建 Cloud 镜像
docker build -t tiangong-deploy/cloud:latest -f Dockerfile.cloud .

# 构建 Agent 镜像
docker build -t tiangong-deploy/agent:latest -f Dockerfile.agent .

# 构建 UI 镜像
docker build -t tiangong-deploy/ui:latest -f Dockerfile.ui .
```

---

## 开发新的执行器插件

### 1. 实现 Executor 接口

创建新文件 `internal/agent/plugins/your_executor.go`:

```go
package plugins

import (
    "github.com/cloud-agent/internal/common"
)

type YourExecutor struct {
    config map[string]interface{}
}

func NewYourExecutor(config map[string]interface{}) *YourExecutor {
    return &YourExecutor{
        config: config,
    }
}

func (e *YourExecutor) Type() common.TaskType {
    return common.TaskType("your_type")
}

func (e *YourExecutor) Execute(
    taskID string,
    command string,
    params map[string]interface{},
    fileID string,
    logCallback LogCallback,
) (string, error) {
    // 实现执行逻辑
    if logCallback != nil {
        logCallback(taskID, "info", "Starting execution...")
    }
    
    // 执行命令
    result := "execution result"
    
    if logCallback != nil {
        logCallback(taskID, "info", "Execution completed")
    }
    
    return result, nil
}

func (e *YourExecutor) Cancel(taskID string) error {
    // 实现取消逻辑
    return nil
}
```

### 2. 注册执行器

在 `internal/agent/executor/plugin_config.go` 中添加：

```go
case common.TaskType("your_type"):
    exec = plugins.NewYourExecutor(pluginDef.Config)
```

### 3. 添加配置

在 `configs/agent-plugins.yaml` 中添加：

```yaml
plugins:
  - type: your_type
    enabled: true
    config:
      # 你的配置参数
      param1: value1
```

---

## 测试

### 运行单元测试

```bash
# 运行所有测试
go test ./...

# 运行特定包的测试
go test ./internal/agent/plugins/...

# 运行测试并显示覆盖率
go test -cover ./...
```

### 运行集成测试

```bash
# 使用 Docker Compose 启动测试环境
docker-compose -f deployments/docker-compose.test.yml up -d

# 运行集成测试
go test -tags=integration ./...

# 清理测试环境
docker-compose -f deployments/docker-compose.test.yml down
```

---

## 代码规范

### Go 代码规范

遵循 [Effective Go](https://golang.org/doc/effective_go.html) 和 [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)

**格式化代码**:
```bash
go fmt ./...
goimports -w .
```

**代码检查**:
```bash
golangci-lint run
```

### 前端代码规范

遵循 [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)

**格式化代码**:
```bash
cd cloud-ui
npm run lint
npm run format
```

---

## 提交规范

使用 [Conventional Commits](https://www.conventionalcommits.org/) 格式：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型**:
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**:
```
feat(agent): add command whitelist security

- Implement CommandValidator with regex patterns
- Add audit logging for all command attempts
- Update shell executor to use validator

Closes #123
```

---

## 发布流程

### 1. 更新版本号

编辑 `VERSION` 文件：
```
v1.1.0
```

### 2. 创建 Git Tag

```bash
git tag -a v1.1.0 -m "Release v1.1.0"
git push origin v1.1.0
```

### 3. 构建和推送镜像

```bash
# 构建镜像
./scripts/build-all.sh v1.1.0

# 推送到 Docker Hub
docker push tiangong-deploy/cloud:v1.1.0
docker push tiangong-deploy/agent:v1.1.0
docker push tiangong-deploy/ui:v1.1.0
```

### 4. 发布 Helm Chart

```bash
cd deployments/helm
helm package tiangong-deploy
helm repo index .
```

---

## 调试技巧

### 使用 Delve 调试

```bash
# 安装 Delve
go install github.com/go-delve/delve/cmd/dlv@latest

# 调试 Cloud
dlv debug ./cmd/cloud -- -addr :8080

# 调试 Agent
dlv debug ./cmd/agent -- -cloud http://localhost:8080
```

### 查看日志

```bash
# Cloud 日志
tail -f logs/cloud.log

# Agent 日志
tail -f logs/agent.log

# 审计日志
tail -f logs/agent.log | grep AUDIT
```

### 使用 pprof 性能分析

```bash
# 启用 pprof
go run cmd/cloud/main.go -pprof :6060

# 访问 pprof
go tool pprof http://localhost:6060/debug/pprof/profile
```

---

## 常见问题

### 1. 编译错误：找不到包

```bash
# 清理并重新下载依赖
go clean -modcache
go mod download
```

### 2. WebSocket 连接失败

检查 Cloud 服务是否正常运行：
```bash
curl http://localhost:8080/health
```

### 3. 前端开发服务器无法连接后端

检查 `cloud-ui/vite.config.ts` 中的代理配置：
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:8080',
    changeOrigin: true,
  },
}
```

---

## 贡献指南

### 提交 Pull Request

1. Fork 仓库
2. 创建特性分支 (`git checkout -b feature/amazing-feature`)
3. 提交更改 (`git commit -m 'feat: add amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建 Pull Request

### PR 检查清单

- [ ] 代码通过所有测试
- [ ] 添加了必要的测试
- [ ] 更新了相关文档
- [ ] 遵循代码规范
- [ ] Commit 消息符合规范

---

## 资源链接

- [项目仓库](https://github.com/your-org/tiangong-deploy)
- [问题追踪](https://github.com/your-org/tiangong-deploy/issues)
- [讨论区](https://github.com/your-org/tiangong-deploy/discussions)
- [Wiki](https://github.com/your-org/tiangong-deploy/wiki)

---

## 许可证

[MIT License](../LICENSE)
