# Tiangong Deploy - 架构设计

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Cloud Server                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │   UI     │  │   API    │  │   Auth   │  │  Files  │ │
│  │ (React)  │  │  (Gin)   │  │  (Token) │  │ Storage │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
│  ┌──────────────────────────────────────────────────┐   │
│  │           Task Manager & WebSocket Hub           │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │              Database (SQLite)                   │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        │ WSS/HTTPS
                        ▼
┌─────────────────────────────────────────────────────────┐
│                    Agent (DaemonSet)                    │
│  ┌──────────────────────────────────────────────────┐   │
│  │            WebSocket Client                      │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │            Executor Manager                      │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐          │   │
│  │  │  Shell  │  │   SQL   │  │   K8s   │  ...     │   │
│  │  └─────────┘  └─────────┘  └─────────┘          │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Security Validator & Audit Logger        │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        │ nsenter (optional)
                        ▼
                  Host Namespace
```

---

## 核心组件

### Cloud Server

#### 1. UI 服务
- **技术栈**: React + TypeScript + Vite
- **功能**:
  - Agent 管理界面
  - 任务创建和执行
  - 实时日志查看
  - 文件上传管理
- **部署**: Nginx 静态文件服务 + 反向代理

#### 2. API 服务
- **技术栈**: Golang + Gin
- **功能**:
  - RESTful API
  - WebSocket 连接管理
  - 任务调度
  - 文件存储
- **端口**: 8080 (HTTP) / 8443 (HTTPS)

#### 3. 数据库
- **默认**: SQLite (单机部署)
- **可选**: PostgreSQL (生产环境)
- **数据模型**:
  - Agents: Agent 注册信息
  - Tasks: 任务记录
  - Logs: 执行日志
  - Files: 文件元数据

---

### Agent

#### 1. WebSocket Client
- **协议**: WSS (WebSocket Secure)
- **功能**:
  - 保持与 Cloud 的长连接
  - 接收任务指令
  - 上报执行结果和日志
- **心跳**: 30秒间隔

#### 2. Executor Manager
- **功能**:
  - 管理多种执行器
  - 任务调度和并发控制
  - 超时和取消处理

#### 3. 执行器插件

| 执行器 | 功能 | 状态 |
|--------|------|------|
| **ShellExecutor** | 执行 Shell 命令 | ✅ 已实现 |
| **MySQLExecutor** | 执行 MySQL SQL (via goInception) | ✅ 已实现 |
| **PostgresExecutor** | 执行 PostgreSQL SQL | ✅ 已实现 |
| **MongoExecutor** | 执行 MongoDB 操作 | ✅ 已实现 |
| **ESExecutor** | 执行 Elasticsearch DSL | ✅ 已实现 |
| **ClickHouseExecutor** | 执行 ClickHouse SQL | ✅ 已实现 |
| **K8sExecutor** | 执行 Kubernetes 操作 | ✅ 已实现 |
| **FileExecutor** | 文件传输 | ✅ 已实现 |
| **APIExecutor** | HTTP API 调用 | ✅ 已实现 |

#### 4. 安全组件

**Command Validator**:
- 基于正则表达式的命令白名单/黑名单
- 防止危险操作（rm -rf /, shutdown 等）
- 防止命令注入（;, &&, ||）

**Audit Logger**:
- 记录所有命令执行尝试
- JSON 格式审计日志
- 包含时间戳、Agent ID、任务 ID、命令、结果

---

## 通信协议

### WebSocket 消息格式

```go
type Message struct {
    Type string      `json:"type"`
    Data interface{} `json:"data"`
}
```

### 消息类型

| 类型 | 方向 | 说明 |
|------|------|------|
| `agent_register` | Agent → Cloud | Agent 注册 |
| `agent_status` | Cloud → Agent | Agent 状态更新 |
| `task_create` | Cloud → Agent | 创建任务 |
| `task_complete` | Agent → Cloud | 任务完成 |
| `task_log` | Agent → Cloud | 任务日志 |
| `task_cancel` | Cloud → Agent | 取消任务 |

### 任务数据结构

```go
type TaskCreateData struct {
    TaskID  string                 `json:"task_id"`
    Type    TaskType               `json:"type"`
    Command string                 `json:"command"`
    Params  map[string]interface{} `json:"params"`
    FileID  string                 `json:"file_id"`
}
```

---

## 安全架构

### 1. 网络安全
- **TLS/WSS**: 所有通信加密
- **自签名证书**: 支持内网部署
- **mTLS**: 可选的双向认证

### 2. 命令安全
- **白名单**: 只允许安全命令
- **黑名单**: 阻止危险操作
- **审计**: 完整的命令执行记录

### 3. 权限控制
- **RBAC**: Kubernetes ClusterRole/ClusterRoleBinding
- **最小权限**: Agent 只获得必要的权限
- **环境隔离**: 不同环境使用不同的 Agent

### 4. 宿主机访问（可选）
- **nsenter**: 进入宿主机命名空间
- **特权容器**: privileged: true
- **风险**: 完全的宿主机访问权限
- **建议**: 仅在必要时启用，配合命令白名单使用

---

## 部署架构

### Docker Compose 部署

```
┌─────────────────┐
│   Cloud (8080)  │
└────────┬────────┘
         │
         ├─ UI (80)
         │
         └─ Agent
```

### Kubernetes 部署

```
┌──────────────────────────────┐
│         Namespace            │
│  ┌────────────────────────┐  │
│  │  Cloud Deployment      │  │
│  │  - Replicas: 1         │  │
│  │  - Service: ClusterIP  │  │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │  UI Deployment         │  │
│  │  - Replicas: 1         │  │
│  │  - Service: LoadBalancer│ │
│  └────────────────────────┘  │
│  ┌────────────────────────┐  │
│  │  Agent DaemonSet       │  │
│  │  - One per node        │  │
│  └────────────────────────┘  │
└──────────────────────────────┘
```

---

## 数据流

### 任务执行流程

```
1. UI/API 创建任务
   ↓
2. Cloud 保存任务到数据库
   ↓
3. Cloud 通过 WebSocket 发送任务给 Agent
   ↓
4. Agent 验证命令（白名单检查）
   ↓
5. Agent 执行任务
   ↓
6. Agent 实时上报日志（WebSocket）
   ↓
7. Agent 上报执行结果
   ↓
8. Cloud 更新任务状态
   ↓
9. UI 显示结果
```

### 文件传输流程

```
1. UI 上传文件到 Cloud
   ↓
2. Cloud 保存文件到存储
   ↓
3. Cloud 创建文件传输任务
   ↓
4. Agent 从 Cloud 下载文件
   ↓
5. Agent 保存文件到目标路径
   ↓
6. Agent 上报传输结果
```

---

## 扩展性设计

### 1. 插件化执行器
- 统一的 `Executor` 接口
- 易于添加新的执行器类型
- 配置文件驱动的插件加载

### 2. 水平扩展
- Cloud 可以多副本部署（需要共享存储）
- Agent 可以部署到多个节点
- WebSocket 连接负载均衡

### 3. 监控集成
- Prometheus 指标导出（预留）
- 日志聚合（ELK/Loki）
- 分布式追踪（OpenTelemetry）

---

## 技术选型理由

| 组件 | 选型 | 理由 |
|------|------|------|
| **后端语言** | Golang | 高性能、并发友好、部署简单 |
| **前端框架** | React | 生态丰富、组件化 |
| **通信协议** | WebSocket | 实时双向通信、长连接 |
| **数据库** | SQLite | 零配置、适合单机部署 |
| **容器化** | Docker | 标准化部署、易于分发 |
| **编排** | Kubernetes | 云原生、自动化运维 |

---

## 性能指标

### 目标性能
- **并发任务**: 100+ 任务/Agent
- **WebSocket 连接**: 1000+ Agent
- **日志吞吐**: 10MB/s
- **文件传输**: 100MB/s

### 资源需求
- **Cloud**: 2 CPU, 4GB RAM
- **Agent**: 0.5 CPU, 512MB RAM
- **数据库**: 1GB 存储（初始）

---

## 下一步演进

1. **高可用**: Cloud 多副本 + 共享存储
2. **监控**: Prometheus + Grafana
3. **审计增强**: 完整的操作审计和回放
4. **权限细化**: 基于角色的访问控制
5. **自动化**: 发布渠道和自动推广
